---
title: "Homework 6"
author: "Jyoti Ankam"
date: "November 25, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
```

Installing the required libraries

```{r}
library(tidyverse)
library(modelr)
```

Problem 1
Reading in the dataset using read_csv. We will now create a city_with_state variable (e.g. “Baltimore, MD”), and a binary variable showing if the homicide was solved. Additionally, we will also remove the follwing states - Phoenix, AZ; Dallas, TX; and Kansas City, MO as these states do not report the victim's races and also Tulsa, AL as this seems to be an error in data entry.

Next we will modify victim_race such that it has the categories white and non-white, making white the reference category and making victim_age numeric.

```{r}
hom_df = read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv", col_names = TRUE) %>% 
  mutate(city_with_state = str_c(city, ",", " ", state),
         solved = if_else(disposition == "Closed by arrest", "resolved", "unresolved"),
         solved = fct_relevel(solved, "unresolved"),
         victim_race = tolower(victim_race),
         colpsd_victim_race = fct_collapse(victim_race, "non-white" = c("asian","black", "hispanic", "other", "unknown")),
         colpsd_victim_race = fct_relevel(colpsd_victim_race, "white"),
         victim_age = as.numeric(victim_age)) %>% 
  filter(!(city_with_state %in% c("Phoenix, AZ", "Dallas, TX", "Kansas City, MO", "Tulsa, AL")))

```

Let us now use the glm function to fit a logistic regression for the city of Baltimore, M.D. wherein the outcome is dichotomous (resolved vs unresolved) and the predictors are victim age, sex and race. Additionally, let us obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all the other variables constant.

```{r}

balt_df = hom_df %>% 
  filter(city_with_state == "Baltimore, MD")

logis_balt = glm(solved ~ victim_age + victim_sex + colpsd_victim_race, data = balt_df, family = binomial())

logis_balt %>% broom::tidy() %>% 
  janitor::clean_names() %>% 
  mutate(OR = exp(estimate),
         lower_95_ci = exp(estimate - (1.96 * std_error)),
         upper_95_ci = exp(estimate + (1.96 * std_error))) %>% 
  filter(term == "colpsd_victim_racenon-white") %>% 
  select(OR, lower_95_ci, upper_95_ci) %>% 
  knitr::kable(digits = 3)

```

From the above, we know the odds of solving homicides in non-white victims vs white victims is 0.441 after adjusting for sex and age. We are also 95% confident that the odss lie between 0.31 and 0.62.

Next, we will run the glm function for each one of the cities and extract the adjusted odds ratio and CI for solving homicides comparing non-white victims to white victims.

```{r}

logis_cities = hom_df %>% 
  
  # Selecting only the variables needed
  select(city_with_state, solved, victim_age, victim_sex, colpsd_victim_race) %>%
  # Making list columns to use for the iteration
  group_by(city_with_state) %>% 
  nest() %>% 
  
  # Using maps to iterate the glm and tidy functions
  mutate(models = map(.x = data, ~ glm(solved ~ victim_sex + colpsd_victim_race + victim_age, 
                                      family = binomial, data = .x)),
         models = map(models, broom::tidy)) %>% 
  select(-data) %>% unnest() %>% 
  filter(term == "colpsd_victim_racenon-white") %>% 
  mutate(OR = exp(estimate),
  # Calculating the 95% confidence intervals
         lower_95_ci = exp(estimate - (1.96*std.error)),
         upper_95_ci = exp(estimate + (1.96*std.error))) %>% 
  select(city_with_state, OR, lower_95_ci, upper_95_ci) %>% 
  
  # Organizing cities according to estimated OR from the lowest to highest
  mutate(city_with_state = reorder(city_with_state, OR))

```

